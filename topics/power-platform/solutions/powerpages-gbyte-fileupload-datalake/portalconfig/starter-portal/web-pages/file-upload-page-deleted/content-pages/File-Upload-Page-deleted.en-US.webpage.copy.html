<title>File Uploader</title>
<script src="js/jquery-1.7.1.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="css/modern.css">
<script>
  var maxBlockSize = 512 * 1024; //Each file will be split in 256 KB.
  var numberOfBlocks = 1;
  var selectedFile = null;
  var currentFilePointer = 0;
  var totalBytesRemaining = 0;
  var blockIds = new Array();
  var blockIdPrefix = & amp;
  amp;
  quot;
  block - & amp;
  amp;
  quot;;
  var submitUri = null;
  var bytesUploaded = 0;
  $(document).ready(function() {
    $( & amp; amp; quot; #output & amp; amp; quot;).hide();
    $( & amp; amp; quot; #file & amp; amp; quot;).bind( & amp; amp; #039;change&amp;amp;# 039;, handleFileSelect);
    if (window.File & amp; amp; amp; & amp; amp; amp; window.FileReader & amp; amp; amp; & amp; amp; amp; window.FileList & amp; amp; amp; & amp; amp; amp; window.Blob) {
      // Great success! All the File APIs are supported.
    } else {
      alert( & amp; amp; #039;The File APIs are not fully supported in this browser.&amp;amp;# 039;);
    }
  });
  //Read the file and find out how many blocks we would need to split it.
  function handleFileSelect(e) {
    maxBlockSize = 512 * 1024;
    currentFilePointer = 0;
    totalBytesRemaining = 0;
    var files = e.target.files;
    selectedFile = files[0];
    $( & amp; amp; quot; #output & amp; amp; quot;).show();
    $( & amp; amp; quot; #fileName & amp; amp; quot;).text(selectedFile.name);
    $( & amp; amp; quot; #fileSize & amp; amp; quot;).text(selectedFile.size);
    $( & amp; amp; quot; #fileType & amp; amp; quot;).text(selectedFile.type);
    var fileSize = selectedFile.size;
    if (fileSize & amp; amp; lt; maxBlockSize) {
      maxBlockSize = fileSize;
      console.log( & amp; amp; quot; max block size = & amp; amp; quot; + maxBlockSize);
    }
    totalBytesRemaining = fileSize;
    if (fileSize % maxBlockSize == 0) {
      numberOfBlocks = fileSize / maxBlockSize;
    } else {
      numberOfBlocks = parseInt(fileSize / maxBlockSize, 10) + 1;
    }
    console.log( & amp; amp; quot; total blocks = & amp; amp; quot; + numberOfBlocks);
    var baseUrl = $( & amp; amp; quot; #sasUrl & amp; amp; quot;).val();
    var indexOfQueryStart = baseUrl.indexOf( & amp; amp; quot; ? & amp; amp; quot;);
    submitUri = baseUrl.substring(0, indexOfQueryStart) + & amp;
    amp;
    #039;/&amp;amp;# 039; + selectedFile.name + baseUrl.substring(indexOfQueryStart);
    console.log(submitUri);
  }
  var reader = new FileReader();
  reader.onloadend = function(evt) {
    if (evt.target.readyState == FileReader.DONE) { // DONE == 2
      var uri = submitUri + & amp;
      amp;
      #039;&amp;amp;amp;comp= block & amp;
      amp;
      amp;
      blockid = & amp;
      amp;
      #039; + blockIds[blockIds.length - 1];
                var requestData = new Uint8Array(evt.target.result);
      $.ajax({
        url: uri,
        type: & amp;amp;quot;PUT & amp;amp;quot;,
        data: requestData,
        processData: false,
        beforeSend: function(xhr) {
          //xhr.setRequestHeader(&amp;amp;#039;x-ms-blob-type&amp;amp;#039;, &amp;amp;#039;BlockBlob&amp;amp;#039;);
          //xhr.setRequestHeader(&amp;amp;#039;Content-Length&amp;amp;#039;, requestData.length);
        },
        success: function(data, status) {
          console.log(data);
          console.log(status);
          bytesUploaded += requestData.length;
          var percentComplete = ((parseFloat(bytesUploaded) / parseFloat(selectedFile.size)) * 100).toFixed(2);
          $( & amp; amp; quot; #fileUploadProgress & amp; amp; quot;).text(percentComplete + & amp; amp; quot; % & amp; amp; quot;);
          uploadFileInBlocks();
        },
        error: function(xhr, desc, err) {
          console.log(desc);
          console.log(err);
        }
      });
    }
  };
  function uploadFileInBlocks() {
    if (totalBytesRemaining & amp; amp; gt; 0) {
      console.log( & amp; amp; quot; current file pointer = & amp; amp; quot; + currentFilePointer + & amp; amp; quot; bytes read = & amp; amp; quot; + maxBlockSize);
      var fileContent = selectedFile.slice(currentFilePointer, currentFilePointer + maxBlockSize);
      var blockId = blockIdPrefix + pad(blockIds.length, 6);
      console.log( & amp; amp; quot; block id = & amp; amp; quot; + blockId);
      blockIds.push(btoa(blockId));
      reader.readAsArrayBuffer(fileContent);
      currentFilePointer += maxBlockSize;
      totalBytesRemaining -= maxBlockSize;
      if (totalBytesRemaining & amp; amp; lt; maxBlockSize) {
        maxBlockSize = totalBytesRemaining;
      }
    } else {
      commitBlockList();
    }
  }
  function commitBlockList() {
    var uri = submitUri + & amp;
    amp;
    #039;&amp;amp;amp;comp= blocklist & amp;
    amp;
    #039;;
            console.log(uri);
            var requestBody = & amp;
    amp;
    #039;&lt;?xml version= & amp;
    amp;
    quot;
    1.0 & amp;
    amp;
    quot;
    encoding = & amp;
    amp;
    quot;
    utf - 8 & amp;
    amp;
    quot; ? & amp;
    amp;
    gt; & amp;
    amp;
    lt;
    BlockList & amp;
    amp;
    gt; & amp;
    amp;
    #039;;
            for (var i = 0;
    i & amp;
    amp;
    lt;
    blockIds.length;
    i++) {
    requestBody += & amp;
    amp;
    #039;&lt;Latest&gt;&amp;amp;# 039; + blockIds[i] + & amp;
    amp;
    #039;&lt;/Latest&gt;&amp;amp;# 039;;
  }
  requestBody += & amp;
  amp;
  #039;&lt;/BlockList&gt;&amp;amp;# 039;;
  console.log(requestBody);
  $.ajax({
    url: uri,
    type: & amp;amp;quot;PUT & amp;amp;quot;,
    data: requestBody,
    beforeSend: function(xhr) {
      //xhr.setRequestHeader(&amp;amp;#039;x-ms-blob-content-type&amp;amp;#039;, selectedFile.type);
      //xhr.setRequestHeader(&amp;amp;#039;Content-Length&amp;amp;#039;, requestBody.length);
    },
    success: function(data, status) {
      console.log(data);
      console.log(status);
    },
    error: function(xhr, desc, err) {
      console.log(desc);
      console.log(err);
    }
  });
  }
  function pad(number, length) {
    var str = & amp;
    amp;
    #039;&amp;amp;# 039; + number;
    while (str.length & amp; amp; lt; length) {
      str = & amp;
      amp;
      #039;0&amp;amp;# 039; + str;
    }
    return str;
  }
</script>
<form>
  <div style="margin-left: 20px;">
    <h1>File Uploader</h1>
    <p><strong>SAS URI</strong>:
      <br><span class="input-control text"><input type="text" id="sasUrl" value="" style="width: 50%;"></span>
    </p>
    <p><strong>File To Upload</strong>:
      <br><span class="input-control text"><input type="file" id="file" name="file" style="width: 50%;"></span>
    </p>
    <div id="output"><strong>File Properties:</strong><br>
      <p>
        Name: <span id="fileName"></span></p>
      <p>
        File Size: <span id="fileSize"></span> bytes.
      </p>
      <p>
        File Type: <span id="fileType"></span></p>
      <p><input type="button" value="Upload File" onclick="uploadFileInBlocks()"></p>
      <p><strong>Progress</strong>: <span id="fileUploadProgress">0.00 %</span></p>
    </div>
  </div>
  <div>
  </div>
</form>